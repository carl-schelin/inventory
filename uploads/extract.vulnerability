#!/bin/bash

cd /usr/local/httpd/htsecure/inventory/uploads

if [[ -f vulnerability-sorted.csv ]]
then
  rm vulnerability-sorted.csv
fi

SKIP=no
if [[ "$1" = 'skip' ]]
then
  SKIP=yes
fi

for LAST in `ls vulnerability.current.csv`
do

  INFO=`    grep -c ',"Info",'     $LAST`
  LOW=`     grep -c ',"Low",'      $LAST`
  MEDIUM=`  grep -c ',"Medium",'   $LAST`
  HIGH=`    grep -c ',"High",'     $LAST`
  CRITICAL=`grep -c ',"Critical",' $LAST`

  if [[ $SKIP = 'no' ]]
  then
    echo "$LAST:	INFO: $INFO LOW: $LOW MEDIUM: $MEDIUM HIGH: $HIGH CRITICAL: $CRITICAL"
  fi
done


DATE=`date +"%Y"`

LAST=vulnerability.current.csv

# import all vulnerabilities
#egrep ',"(Critical|High)",' $LAST > vulnerability-sorted.csv
sort $LAST | uniq | grep -v "^\"Plugin" > vulnerability-sorted.csv

if [[ $SKIP = 'no' ]]
then
  ls -l vulnerability*

  echo "done? family upload next..."
  read
  echo ""
  echo ""
fi

/usr/local/bin/php upload.family.php

if [[ $SKIP = 'no' ]]
then
  echo "done? security upload next..."
  read
  echo ""
  echo ""
fi

/usr/local/bin/php upload.security.php

if [[ $SKIP = 'no' ]]
then
  echo ""
  echo ""
  echo "done? upload next..."
  read

  echo ""
  echo ""
fi

/usr/local/bin/php upload.vulnerability.php

