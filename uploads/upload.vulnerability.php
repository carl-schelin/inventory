<?php
# Script: upload.vulnerability.php
# Owner: Carl Schelin
# Coding Standard 3.0 Applied
# See: https://incowk01/makers/index.php/Coding_Standards
# Description:

  include('settings.php');
  include($Sitepath . '/function.php');

  function dbconn($server,$database,$user,$pass){
    $db = mysql_connect($server,$user,$pass);
    $db_select = mysql_select_db($database,$db);
    return $db;
  }

  $db = dbconn($DBserver, $DBname, $DBuser, $DBpassword);

  if (isset($argv[1])) {
    $date = $argv[1];
  } else {
    $date = date('Y-m-d');
  }

  $q_string  = "update vulnerabilities set vuln_deldate = \"" . $date . "\" where vuln_deldate = '0000-00-00' ";
  $insert = mysql_query($q_string) or die($q_string . ": " . mysql_error());

  $q_string  = "update vulnerabilities set vuln_delete = 1 ";
  $insert = mysql_query($q_string) or die($q_string . ": " . mysql_error());

# legend
  print "Usage:\n";
  print "php upload.vulnerability.php [date]\n\n";
  print "+ - Found the interface, adding vulnerability\n";
  print "^ - Found the interface and vulnerability, updating\n";
  print ". - Interface not found\n";

  if (($handle = fopen("vulnerability-sorted.csv", "r")) !== FALSE) {
    while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {
      $q_string  = "select int_id,inv_manager ";
      $q_string .= "from interface ";
      $q_string .= "left join inventory on inventory.inv_id = interface.int_companyid ";
      $q_string .= "where int_addr = '" . $data[4] . "' and inv_status = 0 ";
      $q_interface = mysql_query($q_string) or die($q_string . ": " . mysql_error());
      if (mysql_num_rows($q_interface) > 0) {
        $a_interface = mysql_fetch_array($q_interface);

        $q_string  = "select vuln_id ";
        $q_string .= "from vulnerabilities ";
        $q_string .= "where vuln_interface = " . $a_interface['int_id'] . " and vuln_securityid = " . $data[0] . " ";
        $q_vulnerabilities = mysql_query($q_string) or die($q_string . ": " . mysql_error());
        if (mysql_num_rows($q_vulnerabilities) == 0) {
          if ($data[3] != '') {
            $q_string  = "insert ";
            $q_string .= "into vulnerabilities set ";
            $q_string .= "vuln_id = null,";
            $q_string .= "vuln_interface = " . $a_interface['int_id'] . ",";
            $q_string .= "vuln_securityid = " . $data[0] . ",";
            $q_string .= "vuln_date = '" . $date . "',";
            $q_string .= "vuln_group = " . $a_interface['inv_manager'];
            $insert = mysql_query($q_string) or die($q_string . ": " . mysql_error());
            print "+";

#            $q_string  = "insert ";
#            $q_string .= "into intvuln ";
#            $q_string .= "set iv_id = null,iv_intid = " . $a_interface['int_id'] . ",iv_securityid = " . $data[0] . ",iv_date = '" . $date . "' ";
#            $insert = mysql_query($q_string) or die($q_string . ": " . mysql_error());
          }
        } else {
          $a_vulnerabilities = mysql_fetch_array($q_vulnerabilities);

          $q_string  = "update ";
          $q_string .= "vulnerabilities ";
          $q_string .= "set ";
          $q_string .= "vuln_delete = 0,";
          $q_string .= "vuln_deldate = '0000-00-00' ";
          $q_string .= "where vuln_id = " . $a_vulnerabilities['vuln_id'] . " ";
          $insert = mysql_query($q_string) or die($q_string . ": " . mysql_error());
          print "^";
        }
      } else {
        print ".";
      }
    }

    print "\n\n";
    fclose($handle);
  }

?>
