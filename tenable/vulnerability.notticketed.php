<?php
        $instruct = '';
        $product = '';
        $q_string  = "select vuln_id,vuln_interface,vuln_securityid,vuln_duplicate,inv_product,inv_name,int_server,";
        $q_string .= "int_addr,vuln_group ";
        $q_string .= "from vulnerabilities ";
        $q_string .= "left join interface on interface.int_id           = vulnerabilities.vuln_interface ";
        $q_string .= "left join inventory on inventory.inv_id           = interface.int_companyid ";
        $q_string .= "left join products on products.prod_id            = inventory.inv_product ";
        $q_string .= $q_location;
        $q_string .= "left join vulnowner on vulnowner.vul_interface = vulnerabilities.vuln_interface and vulnowner.vul_security = vulnerabilities.vuln_securityid ";
        $q_string .= $where . " and vul_ticket = '' ";
        $q_string .= $orderby;
        $q_vulnerabilities = mysqli_query($db, $q_string) or die(header("Location: " . $Siteroot . "/error.php?script=" . $package . "&error=" . $q_string . "&mysql=" . mysqli_error($db)));
        if (mysqli_num_rows($q_vulnerabilities) > 0) {
          while ($a_vulnerabilities = mysqli_fetch_array($q_vulnerabilities)) {

# get vulowner and ticket from interface id and security id in vulowner table
            $q_string  = "select vul_id,vul_group,vul_ticket,vul_exception,vul_description ";
            $q_string .= "from vulnowner ";
            $q_string .= "where vul_security = " . $a_vulnerabilities['vuln_securityid'] . " and vul_interface = " . $a_vulnerabilities['vuln_interface'] . " ";
            $q_vulnowner = mysqli_query($db, $q_string) or die(header("Location: " . $Siteroot . "/error.php?script=" . $package . "&error=" . $q_string . "&mysql=" . mysqli_error($db)));
            $a_vulnowner = mysqli_fetch_array($q_vulnowner);

            if ($product != $a_vulnerabilities['inv_name']) {
              $output   .= $instruct;
              $output   .= "<hr>";
              $output   .= "<p>Mitigate the listed vulnerabilities - " . $a_vulnerabilities['inv_name'] . "<br>\n";
              $output   .= "The following vulnerabilities have been identified for the listed IP addresses.</p>\n";
              $output   .= "<p><pre>";
              $product = $a_vulnerabilities['inv_name'];
            }

            $output   .= $a_vulnerabilities['vuln_securityid'] . " ";
            $output   .= sprintf("%20s", $prodname[$a_vulnerabilities['inv_product']]) . " ";
            $output   .= sprintf("%15s", $a_vulnerabilities['inv_name']) . " ";
            $output   .= sprintf("%15s", $a_vulnerabilities['int_server']) . " ";
            $output   .= sprintf("%15s", $a_vulnerabilities['int_addr']) . " ";
            $output   .= $secname[$a_vulnerabilities['vuln_securityid']] . " ";
            $output   .= $grpname[$a_vulnowner['vul_group']] . " ";
            $output   .= $sevname[$a_vulnerabilities['vuln_securityid']] . "\n";

            $instruct = "</pre></p><p>Instructions: https://lnmt1cuomwiki1.internal.pri/wiki/index.php?title=Vulnerability_Mitigation_Process.</p>\n";
          }
        }

        $output   .= $instruct;
        $output   .= "<hr>";

        mysqli_free_result($q_vulnerabilities);

        print "document.getElementById('table_mysql').innerHTML = '" . mysqli_real_escape_string($db, $output) . "';\n\n";

        print "document.vulnerability.update.disabled = true;\n";
        print "document.vulnerability.vul_group.focus();\n";

?>
