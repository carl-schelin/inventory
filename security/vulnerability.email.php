<?php
# Script: vulnerability.email.php
# Owner: Carl Schelin
# Coding Standard 3.0 Applied
# Description: Retrieve data and update the database with the new info. Prepare and display the table

  header('Content-Type: text/javascript');

  include('settings.php');
  $called = 'yes';
  include($Loginpath . '/check.php');
  include($Sitepath . '/function.php');

# pass the inv_id to this script.
# get all the interface IDs for this server (inv_id -> int_companyid)
# search the vulnowner listing for any interface ID without an associated ticket
# generate the ticket text
# update vulnowner with ticket WO000000000000 to show it's been assigned.


# one ticket; click Generate and this is what's sent:
#
# vulnerability.email.php?inv_id=9565&grp_id=1&sev_id=2
#

  if (isset($_SESSION['username'])) {
    $package = "vulnerability.email.php";
    $formVars['inv_id']    = clean($_GET['inv_id'],   10);
    $formVars['sev_id']    = clean($_GET['sev_id'],   10);
    $formVars['grp_id']    = clean($_GET['grp_id'],   10);

# defaults for testing.
    if ($formVars['inv_id'] == '') {
      $formVars['inv_id'] = 929;
    }
    if ($formVars['sev_id'] == '') {
      $formVars['sev_id'] = 2;
    }
    if ($formVars['grp_id'] == '') {
      $formVars['grp_id'] = 8;
    }

    if (check_userlevel($db, $AL_Edit)) {

      logaccess($db, $_SESSION['uid'], $package, "Creating the data for viewing.");

      $headers = "From: Site Developer <" . $Sitedev . ">\r\n";
      $headers .= "CC: " . $Sitedev . "\r\n";

      # send it to the dev for testing
      $remedyemail  = $Sitedev;
      # development server information
      $remedyemail  = $Remedydev8;
      $remedyserver = $Remedydevsvr8;
      # production server information
      $remedyemail  = $Remedyprod8;
# 9.1 updates
      $remedyemail .= "," . $Remedyprod9;
      $remedyemail .= "," . $Remedydev9;
      $remedyemail .= "," . $Remedyqa9;

      $remedyserver = $Remedyprodsvr8;

      $sendemail = '';

# get the user information for the person in the inventory and will be the one opening the ticket plus group information
      $q_string  = "select usr_first,usr_last,grp_name ";
      $q_string .= "from users ";
      $q_string .= "left join a_groups on a_groups.grp_id = users.usr_group ";
      $q_string .= "where usr_id = " . $_SESSION['uid'] . " ";
      $q_users = mysqli_query($db, $q_string) or die($q_string . ": " . mysqli_error($db));
      $a_users = mysqli_fetch_array($q_users);

# get the server name
      $q_string  = "select inv_name ";
      $q_string .= "from inventory ";
      $q_string .= "where inv_id = " . $formVars['inv_id'] . " ";
      $q_inventory = mysqli_query($db, $q_string) or die($q_string . ": " . mysqli_error($db));
      $a_inventory = mysqli_fetch_array($q_inventory);

# get the group name
      $q_string  = "select grp_name ";
      $q_string .= "from a_groups ";
      $q_string .= "where grp_id = " . $formVars['grp_id'] . " ";
      $q_groups = mysqli_query($db, $q_string) or die($q_string . ": " . mysqli_error($db));
      $a_groups = mysqli_fetch_array($q_groups);

# get the severity name
      $q_string  = "select sev_name ";
      $q_string .= "from severity ";
      $q_string .= "where sev_id = " . $formVars['sev_id'];
      $q_severity = mysqli_query($db, $q_string) or die($q_string . ": " . mysqli_error($db));
      $a_severity = mysqli_fetch_array($q_severity);

# get the critical or high date depending on what severity says
      $criticaldate = date('n/j/Y g:i:s A', strtotime("+60 days"));
      $highdate = date('n/j/Y g:i:s A', strtotime("+90 days"));

#
# begin the email message
#

      $body  = "First Name+* !1000003297!:" . $a_users['usr_first'] . "\n";
      $body .= "Last Name+* !1000003298!:" . $a_users['usr_last'] . "\n";
      if ($a_severity['sev_name'] == 'Critical') {
        $body .= "Summary* !1000000000!:Mitigate Vulnerabilities on " . $a_inventory['inv_name'] . " by " . $criticaldate . "\n";
      }
      if ($a_severity['sev_name'] == 'High') {
        $body .= "Summary* !1000000000!:Mitigate Vulnerabilities on " . $a_inventory['inv_name'] . " by " . $highdate . "\n";
      }
      $body .= "Description !1000000151!:The following vulnerabilities have been identified for the listed IP addresses.\n\n";

      $q_string  = "select int_id,inv_name,int_server,int_addr,prod_name ";
      $q_string .= "from interface ";
      $q_string .= "left join inventory on inventory.inv_id = interface.int_companyid ";
      $q_string .= "left join products on products.prod_id = inventory.inv_product ";
      $q_string .= "where int_companyid = " . $formVars['inv_id'] . " ";
      $q_interface = mysqli_query($db, $q_string) or die($q_string . ": " . mysqli_error($db));
      while ($a_interface = mysqli_fetch_array($q_interface)) {

# get the vulnowner information based on interface and severity

        $q_string  = "select vul_id,vul_security,grp_name,sev_name,sec_name ";
        $q_string .= "from vulnowner "; 
        $q_string .= "left join a_groups on a_groups.grp_id = vulnowner.vul_group ";
        $q_string .= "left join security on security.sec_id = vulnowner.vul_security ";
        $q_string .= "left join severity on severity.sev_id = security.sec_severity ";
        $q_string .= "where vul_interface = " . $a_interface['int_id'] . " and sev_id = " . $formVars['sev_id'] . " and vul_group = " . $formVars['grp_id'] . " and vul_ticket = '' ";
        $q_vulnowner = mysqli_query($db, $q_string) or die($q_string . ": " . mysqli_error($db));
        if (mysqli_num_rows($q_vulnowner) > 0) {
          while ($a_vulnowner = mysqli_fetch_array($q_vulnowner)) {

            $body .= $a_vulnowner['vul_security'] . " ";
            $body .= sprintf("%20s", $a_interface['prod_name']) . " ";
            $body .= sprintf("%15s", $a_interface['inv_name']) . " ";
            $body .= sprintf("%15s", $a_interface['int_server']) . " ";
            $body .= sprintf("%15s", $a_interface['int_addr']) . " ";
            $body .= $a_vulnowner['sec_name'] . " ";
            $body .= $a_vulnowner['grp_name'] . " ";
            $body .= $a_vulnowner['sev_name'] . "\n";

            $sendemail = 'yes';

            $q_string = "update vulnowner set vul_ticket = 'WO0000000000000' where vul_id = " . $a_vulnowner['vul_id'];
            $result = mysqli_query($db, $q_string);
          }

        }
      }

      $body .= "\nInstructions:\n" . $Wikiroot . "/index.php?title=Vulnerability_Mitigation_Process\n\n";
      $body .= "Manager Support Group Name !1000000015!:" . $a_users['grp_name'] . "\n";
      $body .= "Support Group Name !1000003229!:" . $a_groups['grp_name'] . "\n";
      $body .= "Priority !1000000164!:" . $a_severity['sev_name'] . "\n\n";

      $body .= "#PLEASE DO NOT MODIFY THE BELOW MANDATORY VALUES:\n";
      $body .= "Schema: WOI:WorkOrderInterface_Create\n";
      $body .= "Server: " . $remedyserver . "\n";
      $body .= "Action: Submit\n";
      $body .= "Location Company* !1000000001!: Intrado, Inc.\n";
      $body .= "Company*+ !1000000082!: Intrado, Inc.\n";
      $body .= "Request Manager Company !1000000251!: Intrado, Inc.\n";
      $body .= "Manager Support Organization !1000000014!: Technical Operations\n";
      $body .= "Support Company !1000003228!: Intrado, Inc.\n";
      $body .= "Support Organization !1000003227!: Technical Operations\n";
      $body .= "Work Order Type* !1000000181!: General\n";

      mysqli_free_result($q_interface);

      if ($sendemail == 'yes') {
        mail($remedyemail, 'Vulnerability Ticket', $body, $headers);
        print "document.getElementById('table_mysql').innerHTML = '" . mysqli_real_escape_string($db, $body) . "';\n\n";
        print "alert('Email sent!');\n";
      } else {
        print "alert('Not sent!');\n";
      }

      print "document.vulnerability.update.disabled = true;\n";
      print "document.vulnerability.vul_group.focus();\n";

    } else {
      logaccess($db, $_SESSION['uid'], $package, "Unauthorized access.");
    }
  }
?>
